
<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="last-modified" content="2017-07-31T10:12:35.3059368+02:00" />
    <meta name="keywords" content="refactoring" />
    <title>Refactoring a Feature Envy code | Code with Bojan</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
    <link rel="canonical" href="http://bojanv91.github.io/2017/07/refactoring-a-feature-envy-code/" />
</head>
<body class="home blog">
    <div id="page" class="hfeed site">
        <header id="masthead" class="site-header fancy-container lightgreen" role="banner">
            <hgroup>
                <h1 class="site-title"><a href="/" title="bojanv91" rel="home">Code with Bojan</a></h1>
                <h2><small>Notes on software development</small></h2>
            </hgroup>
            <nav role="navigation" class="site-navigation main-navigation">
                <h1 class="assistive-text">Menu</h1>
                <div class="assistive-text skip-link"><a href="#content" title="Skip to content">Skip to content</a></div>
                <div class="menu">
                    <ul>
                        <li><a href="/about">About</a></li>
                        <li><a href="/category">Categories</a></li>
                        <li><a href="/archive">Archive</a></li>
                        <li><a href="/rss.xml">RSS</a> / <a href="/feed.xml">Atom</a></li>
                    </ul>
                </div>
                <aside id="text-5" class="widget widget_text">
                    <b class="widget-title">Follow</b>
                    <div class="textwidget logos">
                        <a href="https://twitter.com/bojanv91" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://twitter.com']);"><img src="/stylesheets/images/twitter.png"></a>
                        <a href="https://www.linkedin.com/in/bojanv91" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://www.linkedin.com']);"><img src="/stylesheets/images/linkedin.png"></a>
                        <a href="https://github.com/bojanv91" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://github.com']);"><img src="/stylesheets/images/github.png"></a>
                    </div>
                </aside>
                <!--aside id="text-8" class="widget widget_text">
                    <h1 class="widget-title">Other sites</h1>
                    <div class="textwidget">
                        <a href="http://csharptube.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://csharptube.com']);">csharptube.com</a><br />
                        <a href="http://thisisparrot.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://thisisparrot.com']);">Parrot</a><br />
                        <a href="http://shitprogrammerswrite.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://shitprogrammerswrite.com']);">Shit programmers write</a><br />
                    </div>
                </aside-->
                <aside id="archives-4" class="widget widget_archive">
                    <b class="widget-title">Archive</b>
                    <ul class="posts">
                          <li><a href="/archive#20177">July, 2017</a></li>
                          <li><a href="/archive#20173">March, 2017</a></li>
                          <li><a href="/archive#20171">January, 2017</a></li>
                          <li><a href="/archive#201612">December, 2016</a></li>
                          <li><a href="/archive#201610">October, 2016</a></li>
                          <li><a href="/archive#20165">May, 2016</a></li>
                          <li><a href="/archive#20159">September, 2015</a></li>
                          <li><a href="/archive#20153">March, 2015</a></li>
                          <li><a href="/archive#20151">January, 2015</a></li>
                          <li><a href="/archive#201412">December, 2014</a></li>
                    </ul>
                </aside>
            </nav>
        </header>
        <div id="main">
            <div id="primary" class="site-content">
                <div id="content" role="main">
                  


<div id="post">
    <h1>Refactoring a Feature Envy code</h1>

    <div class="post-note">
      posted on 29 Jul 2017
       | <a href="/category/refactoring">refactoring</a>
      
      <div class="addthis_toolbox addthis_default_style" style="float:right;">
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        <a class="addthis_button_tweet"></a>
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
        <a class="addthis_button_linkedin_counter"></a>
        <a class="addthis_counter addthis_pill_style"></a>
      </div>
    </div>
    
    
        
    <p>Recently, in a design review meeting the following question was raised: <em>When refactoring, why sometimes do we put an if-condition statement in a temporary variable, and sometimes in a method in a dependent class?</em>
This is a wonderful question! It opened a discussion spanning across multiple topics, including coupling, domain leaking, encapsulation, and the tell don't ask principle. </p>

<p>Ultimately, checking the <a href="https://blog.codinghorror.com/code-smells/">code smells taxonomy</a>, we identified the code segment in question is a smell called <em>feature envy</em>.<!--excerpt--></p>

<p><strong>Feature envy</strong> is a code smell describing when an object accesses fields of another object in order to perform some action, rather than telling the object to do the action itself.</p>

<p>Let's examine the following [simplified] code segment, and try to refactor it. 
For better context, it addresses the requirement: An active user can pay a pending order. For reporting purposes the order tracks when and who paid it.</p>

<h2>v1 - [simplified] original code segment</h2>

<pre><code>public class PayOrderRequest
{
    public Guid OrderId { get; set; }
}

public class PayOrderHandler : BaseCommandHandler&lt;PayOrderRequest&gt;
{
    public void Handle(PayOrderRequest request)
    {
        var currentUser = Session.Load&lt;User&gt;(LoggedInUserId);
        var order = Session.Load&lt;Order&gt;(request.OrderId);

        // checks if the order can be paid by the currently logged in user
        if (order.Status == OrderStatus.Pending &amp;&amp; currentUser.Status == UserStatus.Active) 
        {
            // pay the order, and record related information
            order.Status = OrderStatus.Completed;
            order.PaidByUserId = currentUser.Id;
            order.PaidOnUtc = DateTime.UtcNow;

            Session.Store(order);
        }
        else
        {
            throw new CoreException($"{currentUser.Name} cannot pay this order.");
        }
    }
}
</code></pre>

<p>The problem with this code, and the reason it is considered a code smell, is because it breaks encapsulation. </p>

<p>The domain logic for performing the paying action on the order object, is leaked out of the order object, into the command handler method. The command handler should only coordinate the workflow, and the order object should be responsible for dealing with the business logic.</p>

<p>Besides breaking encapsulation, it also makes the paying order functionality  harder to unit test. This method depends on the database via the session object, and to the provider of the currently logged in user object. Writing a unit test for this, means that we need to write mocks for both services. If we refactor it, fixing the encapsulation, we'll see that writing unit tests will be a much easier task to do.</p>

<p>Let's observe how can we improve this piece of code, one refactoring step at a time.</p>

<h2>v2 - introduce temporary inline variable for the precondition</h2>

<p>Let's introduce <code>canOrderByPaid</code> boolean variable which will hold the result of the precondition for paying an order.</p>

<pre><code>/* Code removed for clarity */

bool canOrderByPaid = order.Status == OrderStatus.Pending &amp;&amp; currentUser.Status == UserStatus.Active;
if (canOrderByPaid)
{
    order.Status = OrderStatus.Completed;
    order.PaidByUserId = currentUser.Id;
    order.PaidOnUtc = DateTime.UtcNow;

    Session.Store(order);
}
else
{
    throw new CoreException($"{currentUser.Name} cannot pay this order.");
}

/* Code removed for clarity */
</code></pre>

<p>It's better to create a temporary inline variable to describe more complex condition checks, and use it in the if-condition statement, rather than having bloated if-condition statement with a comment above, describing what it does.</p>

<h2>v3 - encapsulate the precondition in the order object</h2>

<p>Now it makes sense to encapsulate the the precondition for paying an order, in the order object itself.</p>

<pre><code>if (order.CanBePaidBy(user)) 
{
    order.Status = OrderStatus.Completed;
    order.PaidByUserId = currentUser.Id;
    order.PaidOnUtc = DateTime.UtcNow;
    Session.Store(order);
}
else
{
    throw new CoreException($"{currentUser.Name} cannot pay this order.");
}
</code></pre>

<p>The order class:</p>

<pre><code>public class Order
{
    /* Code removed for clarity */

    public bool CanBePaidBy(User user) 
        =&gt; Status == OrderStatus.Pending &amp;&amp; user.Status == UserStatus.Active;

    /* Code removed for clarity */
}
</code></pre>

<p>With this change, we eliminated coupling from the command handler to the properties of order and user classes (e.g. <code>order.Status</code>, <code>user.Status</code>). Imagine in more complex cases, how much direct coupling will be reduced only by following good encapsulation.</p>

<h2>v4 - encapsulate the actual action too</h2>

<p>Following the same way how we encapsulated the paying precondition, we'll encapsulate the actual paying action too.</p>

<pre><code>if (order.CanBePaidBy(user))
{
    order.Pay(user);

    Session.Store(order);
}
else
    throw new CoreException($"User {currentUser.Name} cannot pay this order.");
</code></pre>

<p>The order class:</p>

<pre><code>public class Order
{
    /* Code removed for clarity */

    public void Pay(User payer) 
    {
        Status = OrderStatus.Completed;
        PaidByUserId = payer.Id;
        PaidOnUtc = DateTime.UtcNow;
    }

    /* Code removed for clarity */
}
</code></pre>

<h2>v5 - natural final changes</h2>

<p>Observing the refactoring changes in previous steps, this final refactoring change comes natural.</p>

<pre><code>order.Pay(user);

Session.Store(order);
</code></pre>

<p>The order class:</p>

<pre><code>public class Order
{
    /* Code removed for clarity */

    public void Pay(User payer) 
    {
        if (!CanBePaidBy(user))
            throw new CoreException($"User {payer.Name} cannot pay this order.");

        Status = OrderStatus.Completed;
        PaidByUserId = payer.Id;
        PaidOnUtc = DateTime.UtcNow;
    }

    /* Code removed for clarity */
}
</code></pre>

<h2>The resulting refactored code</h2>

<pre><code>public class PayOrderRequest
{
    public Guid OrderId { get; set; }
}

public class PayOrderHandler : BaseCommandHandler&lt;PayOrderRequest&gt;
{
    public void Handle(PayOrderRequest request)
    {
        var currentUser = Session.Load&lt;User&gt;(LoggedInUserId);
        var order = Session.Load&lt;Order&gt;(request.OrderId);

        order.Pay(currentUser);

        Session.Store(order);
    }
}
</code></pre>

<p>The order class:</p>

<pre><code>public class Order
{
    /* Code removed for clarity */
    public OrderStatus Status { get; private set; }
    public Guid PaidByUserId { get; private set; }
    public DateTime PaidOnUtc { get; private set; }

    public void Pay(User payer) 
    {
        if (!CanBePaidBy(user))
            throw new CoreException($"User {payer.Name} cannot pay this order.");

        order.Status = OrderStatus.Completed;
        order.PaidByUserId = payer.Id;
        order.PaidOnUtc = DateTime.UtcNow;
    }

    public bool CanBePaidBy(User user) 
        =&gt; Status == OrderStatus.Pending &amp;&amp; user.Status == UserStatus.Active;

    /* Code removed for clarity */
}
</code></pre>

<h2>Summary</h2>

<p>We made it to the end. Let's summarize the benefits we achieved out of this refactoring session:</p>

<ul>
<li>The command handler <strong>stops asking</strong> for details, now it <strong>tells</strong> the order what to do, providing necessary dependencies, and does not care about the details it does. <strong>Tell Don't Ask Principle</strong> fulfilled.</li>
<li>The <strong>high coupling</strong> from the command handler to the fields in user and order classes is <strong>eliminated</strong>. Less coupling, more sanity.</li>
<li>The <code>Order</code> class is not a bag of public set properties anymore, called a data class. Now it has cohesive behavior, <strong>encapsulating the actions it can perform</strong>.</li>
<li><strong>Domain logic</strong> for paying <strong>is not leaked</strong> in other classes anymore. Now it's located in the responsible class itself. So, only by seeing the <code>Order</code> class we can understand what it can do. No need to open other related classes. Other classes now may be only "users" of this class, calling methods to perform some action/behavior.</li>
<li>Paying functionality now can be easily <strong>unit tested</strong>, without having to deal with special mocking techniques. Less mocks, better tests.</li>
</ul>

<p><strong>Rule of thumb:</strong> Where ever you see a method uses fields of another class extensively, in order to perform some action, consider moving the action in <em>that</em> class itself.</p>

<hr />

<p>If there is interest out there, I might write more about practical refactoring topics and software design from my everyday life.</p>


    <div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://bojanv91.github.io/2017/07/refactoring-a-feature-envy-code/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'bojanveljanovski';
    var disqus_url = 'http://bojanv91.github.io/2017/07/refactoring-a-feature-envy-code/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5496f95f11cffc27"></script>

</div>
                </div>
                <!-- #content -->
            </div>
            <!-- #primary .site-content -->
        </div>
        <!-- #main -->

        <footer id="colophon" class="site-footer" role="contentinfo">
            <div class="site-info">
                Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a>.	
            </div>
            <!-- .site-info -->
        </footer>
        <!-- #colophon .site-footer -->
    </div>
    <!-- #page .hfeed .site -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src='/javascripts/prettify.js' type='text/javascript'></script>
    <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-57647909-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>
    <script type='text/javascript'>
      $(function () {
        $("pre code").parent().each(function () {
          if (!$(this).hasClass("prettyprint")) {
            $(this).addClass("prettyprint");
            a = true
          }
        });

        prettyPrint();
        fixPage_feature_folders();
      });

        function fixPage_feature_folders() {
            var isCorrectPage = window.location.href.indexOf("feature-folders-structure-in-asp-net");
            if(isCorrectPage == -1)
                return;

            var $left = $("#post pre.prettyprint").eq(0);
            var $right =  $("#post pre.prettyprint").eq(1);

            var $wrapLeft = $left.wrap("<div style='width:50%;float:left;'></div>");
            var $wrapRight = $right.wrap("<div style='width:50%;float:left;'></div>");
            $wrapRight.parent().after("<div style='clear:both;'></div>");
        }
    </script>
</body>
</html>
